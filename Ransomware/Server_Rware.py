import socket
import decryptor as dc


con = None
stat = None


def server(host,port):
    global con
    s = socket.socket()

    try:
        s.bind((host,port))
        s.listen(1)
        print("LISTENING...")
    except socket.error as err:
        print("Connection Not established: ", str(err))
        return False

    con, addr = s.accept()
    return True

def recvFile():
    key = con.recv(4096)
    with open('C://Users//91982//Desktop//SGP-sem 5//key.txt', 'wb') as file:
        file.write(key)

    print('Encrypted Key Received Successfully')

    dc.decrypt_key()

    print('Key decrypted successfully')



    try:
        sendFile()
    except:
        print("file Not sent")

def sendFile():
    with open('C://Users//91982//Desktop//SGP-sem 5//key.txt', 'rb') as file:
        key = file.read()

    con.send(key)
    print("File Sent Successfully")
    con.close()


stat = server('',9999)

while True:
    if stat == True:
        req = (con.recv(1024)).decode()

        x = input(("Incoming request from " + req + ", accept[y/n]? "))
        x = x.lower()
        if x == 'y':
            print("Connection Established, waiting for file...")
            con.send('send'.encode())
            recvFile()

            break
        else:
            print("Connection closed!!!")
            stat = False
            con.close()
    else:
        stat = server('',9999)








